import groovy.transform.NonCPS
import jenkins.model.*
import com.cloudbees.hudson.plugins.folder.Folder
import hudson.model.TopLevelItem
import hudson.model.ItemGroup

@NonCPS
String createDraftJob(String originalFullName, String draftFolder, String draftJobName, boolean overwrite) {
  def j = Jenkins.get()

  def original = j.getItemByFullName(originalFullName)
  if (!(original instanceof TopLevelItem)) {
    throw new IllegalArgumentException("Original job not found or not TopLevelItem: " + originalFullName)
  }

  // read xml
  def xml = ((TopLevelItem)original).getConfigFile().asString()

  // create folders
  ItemGroup parent = j
  if (draftFolder?.trim()) {
    draftFolder.split('/').findAll { it?.trim() }.each { folderName ->
      def next = parent.getItem(folderName)
      if (next == null) {
        next = parent.createProject(Folder.class, folderName)
      } else if (!(next instanceof Folder)) {
        throw new IllegalStateException("Item exists but not a folder: " + folderName + " -> " + next.getClass())
      }
      parent = (ItemGroup) next
    }
  }

  // delete draft if exists
  def existing = parent.getItem(draftJobName)
  if (existing != null) {
    if (!overwrite) {
      throw new IllegalStateException("Draft job already exists: " + existing.fullName)
    }
    existing.delete()
  }

  // create new from xml
  def draft = parent.createProjectFromXML(
    draftJobName,
    new ByteArrayInputStream(xml.getBytes("UTF-8"))
  )

  return draft.fullName
}

pipeline {
  agent any

  parameters {
    string(name: 'ORIGINAL_FULLNAME', defaultValue: 'IDB_entitlement-service/entitlement-service_aldon', description: 'Full name of original job')
    string(name: 'DRAFT_FOLDER', defaultValue: 'DRAFTS/IDB_entitlement-service', description: 'Draft folder path')
    string(name: 'DRAFT_JOB_NAME', defaultValue: 'entitlement-service_aldon_draft', description: 'Draft job name')
    booleanParam(name: 'OVERWRITE_DRAFT', defaultValue: false, description: 'Delete draft if exists')
    string(name: 'JIRA_ISSUE', defaultValue: 'ABC-123', description: 'Jira issue key to comment (optional)')
  }

  stages {
    stage('Create draft job') {
      steps {
        script {
          // chỉ nhận về String => serializable
          def draftFullName = createDraftJob(
            params.ORIGINAL_FULLNAME,
            params.DRAFT_FOLDER,
            params.DRAFT_JOB_NAME,
            params.OVERWRITE_DRAFT
          )

          echo "✅ Draft created: ${draftFullName}"
          env.DRAFT_FULLNAME = draftFullName
        }
      }
    }

    stage('Jira comment (safe)') {
      when { expression { return params.JIRA_ISSUE?.trim() } }
      steps {
        // Gọi step ở đây, lúc này scope không giữ Jenkins/Job objects nữa
        jiraAddComment idOrKey: params.JIRA_ISSUE,
                       comment: "Draft job created: ${env.DRAFT_FULLNAME}. Please review/modify then run Step 2 to promote."
      }
    }
  }
}
