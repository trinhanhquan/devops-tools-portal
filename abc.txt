import jenkins.model.*
import com.cloudbees.hudson.plugins.folder.Folder
import hudson.model.TopLevelItem
import hudson.model.ItemGroup

// ========= CONFIG =========
def ORIGINAL_FULLNAME = "IDB_entitlement-service/entitlement-service_aldon"

// Draft location
def DRAFT_FOLDER_FULLNAME = "DRAFTS/IDB_entitlement-service"
def DRAFT_JOB_NAME = "entitlement-service_aldon_draft"

def OVERWRITE_DRAFT_IF_EXISTS = false

// ========= Helpers =========
def j = Jenkins.get()

def mustGetJob(String fullName) {
  def it = j.getItemByFullName(fullName)
  assert it != null : "Original job not found: ${fullName}"
  assert it instanceof TopLevelItem : "Original is not a TopLevelItem: ${fullName} (${it.getClass()})"
  return (TopLevelItem) it
}

def getOrCreateFolder(String folderFullName) {
  def parent = j as ItemGroup
  if (!folderFullName?.trim()) return parent

  folderFullName.split('/').findAll { it?.trim() }.each { name ->
    def next = parent.getItem(name)
    if (next == null) {
      println "Creating folder: ${name}"
      next = parent.createProject(Folder.class, name)
    } else {
      assert next instanceof Folder : "Item '${name}' exists but is not a Folder: ${next.getClass()}"
    }
    parent = (ItemGroup) next
  }
  return parent
}

def deleteIfExists(ItemGroup parent, String name) {
  def existing = parent.getItem(name)
  if (existing != null) {
    assert OVERWRITE_DRAFT_IF_EXISTS : "Draft job already exists: ${existing.fullName}. Set OVERWRITE_DRAFT_IF_EXISTS=true to overwrite."
    println "Deleting existing draft: ${existing.fullName}"
    existing.delete()
  }
}

// ========= Main =========
def original = mustGetJob(ORIGINAL_FULLNAME)
def xml = original.getConfigFile().asString()

def draftParent = getOrCreateFolder(DRAFT_FOLDER_FULLNAME)
deleteIfExists(draftParent, DRAFT_JOB_NAME)

def draft = draftParent.createProjectFromXML(
  DRAFT_JOB_NAME,
  new ByteArrayInputStream(xml.getBytes("UTF-8"))
)

println "âœ… Draft job created: ${draft.fullName}"
println "Now go modify the draft job configuration in UI."
