import groovy.transform.NonCPS
import jenkins.model.*
import hudson.model.TopLevelItem
import java.nio.file.Files
import java.nio.file.Paths
import java.nio.charset.StandardCharsets

@NonCPS
String readJobConfigXml(String fullName) {
  def j = Jenkins.get()
  def item = j.getItemByFullName(fullName)
  if (!(item instanceof TopLevelItem)) {
    throw new IllegalArgumentException("Job not found or not TopLevelItem: " + fullName)
  }
  return ((TopLevelItem)item).getConfigFile().asString()
}

@NonCPS
void overwriteJobConfigXml(String targetFullName, String newXml) {
  def j = Jenkins.get()
  def item = j.getItemByFullName(targetFullName)
  if (!(item instanceof TopLevelItem)) {
    throw new IllegalArgumentException("Job not found or not TopLevelItem: " + targetFullName)
  }
  def job = (TopLevelItem) item
  job.updateByXml(new javax.xml.transform.stream.StreamSource(new StringReader(newXml)))
  job.save()
}

pipeline {
  agent any

  parameters {
    string(name: 'ORIGINAL_FULLNAME', defaultValue: 'IDB_entitlement-service/entitlement-service_aldon', description: 'Full name of original job')
    string(name: 'DRAFT_FULLNAME', defaultValue: 'DRAFTS/IDB_entitlement-service/entitlement-service_aldon_draft', description: 'Full name of draft job')
    booleanParam(name: 'DRY_RUN', defaultValue: true, description: 'If true, do not apply changes')
  }

  stages {
    stage('Backup + Override') {
      steps {
        script {
          // 1) Read XMLs via @NonCPS => Pipeline chỉ giữ String (serializable)
          String oldXml = readJobConfigXml(params.ORIGINAL_FULLNAME)
          String newXml = readJobConfigXml(params.DRAFT_FULLNAME)

          // 2) Backup file in workspace (an toàn permission)
          def ts = new Date().format("yyyyMMdd_HHmmss")
          def safeName = params.ORIGINAL_FULLNAME.replaceAll(/[^A-Za-z0-9_.-]/, "_")
          def backupFile = "backup_${safeName}_${ts}.config.xml"

          writeFile file: backupFile, text: oldXml, encoding: 'UTF-8'
          archiveArtifacts artifacts: backupFile, fingerprint: true

          echo "✅ Backed up original config.xml to ${backupFile}"
          echo "Old XML size: ${oldXml.length()} | New XML size: ${newXml.length()}"
          echo "DRY_RUN=${params.DRY_RUN}"

          // 3) Apply overwrite (still via @NonCPS)
          if (!params.DRY_RUN) {
            overwriteJobConfigXml(params.ORIGINAL_FULLNAME, newXml)
            echo "✅ Overrode original job config.xml from draft."
          } else {
            echo "DRY_RUN=true → not applying overwrite."
          }
