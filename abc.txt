import jenkins.model.*
import hudson.model.TopLevelItem
import java.nio.charset.StandardCharsets

pipeline {
  agent any

  parameters {
    string(name: 'ORIGINAL_FULLNAME', defaultValue: 'IDB_entitlement-service/entitlement-service_aldon', description: 'Full name of original job')
    string(name: 'DRAFT_FULLNAME', defaultValue: 'DRAFTS/IDB_entitlement-service/entitlement-service_aldon_draft', description: 'Full name of draft job')
    booleanParam(name: 'DRY_RUN', defaultValue: true, description: 'If true, do not apply changes')
  }

  stages {
    stage('Read configs') {
      steps {
        script {
          def j = Jenkins.get()

          def mustGetJob = { String fullName ->
            def item = j.getItemByFullName(fullName)
            assert item != null : "Job not found: ${fullName}"
            assert item instanceof TopLevelItem : "Item is not a TopLevelItem: ${fullName} (${item.getClass()})"
            return (TopLevelItem) item
          }

          def original = mustGetJob(params.ORIGINAL_FULLNAME)
          def draft    = mustGetJob(params.DRAFT_FULLNAME)

          // read xml
          def oldXml = original.getConfigFile().asString()
          def newXml = draft.getConfigFile().asString()

          // backup into workspace
          def ts = new Date().format("yyyyMMdd_HHmmss")
          def safeName = { String s -> s.replaceAll(/[^A-Za-z0-9_.-]/, "_") }

          def backupFile = "backup_${safeName(original.fullName)}_${ts}.config.xml"
          writeFile file: backupFile, text: oldXml, encoding: 'UTF-8'

          echo "✅ Backed up original config.xml to workspace: ${backupFile}"
          echo "Original XML size: ${oldXml.length()} | Draft XML size: ${newXml.length()}"
          echo "DRY_RUN=${params.DRY_RUN}"

          // archive backup so you can retrieve it later
          archiveArtifacts artifacts: backupFile, fingerprint: true

          // store for next stage
          currentBuild.description = "Backup: ${backupFile}"
          // stash xml in variables for next stage (simple approach: use env with base64)
          env._NEW_XML_B64 = newXml.bytes.encodeBase64().toString()
        }
      }
    }

    stage('Override original from draft') {
      steps {
        script {
          if (params.DRY_RUN) {
            echo "DRY_RUN=true → not applying update."
            return
          }

          def j = Jenkins.get()
          def originalItem = j.getItemByFullName(params.ORIGINAL_FULLNAME)
          assert originalItem != null && originalItem instanceof TopLevelItem : "Original job not found: ${params.ORIGINAL_FULLNAME}"
          def original = (TopLevelItem) originalItem

          def newXml = new String(env._NEW_XML_B64.decodeBase64(), StandardCharsets.UTF_8)

          // overwrite original config (preserves history)
          original.updateByXml(new javax.xml.transform.stream.StreamSource(new StringReader(newXml)))
          original.save()

          echo "✅ Overrode original job configuration from draft config.xml"
        }
      }
    }
  }
}
