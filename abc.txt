import uuid
from sqlalchemy import Column, String, DateTime
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.sql import func

class UserRole(Base):
    __tablename__ = "user_roles"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    username = Column(String, index=True, nullable=False)
    role = Column(String, nullable=False)

    created_at = Column(DateTime(timezone=True), server_default=func.now(), nullable=False)
    created_by = Column(String, nullable=True)


docker compose exec -T web alembic revision --autogenerate -m "add user_roles table"

docker compose exec -T web alembic upgrade head

docker compose exec -T postgres psql -U recert -d recertdb -c "\dt"

from app.db.models import UserRole
from app.db.database import SessionLocal  # đúng import theo project bạn

def get_roles_for_user(username: str) -> list[str]:
    with SessionLocal() as db:
        rows = db.query(UserRole.role).filter(UserRole.username == username).all()
        roles = [r[0] for r in rows]
    if "recert_user" not in roles:
        roles.append("recert_user")
    return roles

def add_role(username: str, role: str, actor: str | None = None):
    with SessionLocal() as db:
        db.add(UserRole(username=username, role=role, created_by=actor))
        db.commit()

def remove_role(username: str, role: str):
    with SessionLocal() as db:
        db.query(UserRole).filter(UserRole.username == username, UserRole.role == role).delete()
        db.commit()



from app.db.repository import get_roles_for_user

roles = get_roles_for_user(ldap_user["username"])

user = {
  "username": ldap_user["username"],
  "roles": roles,
  "auth_type": "ldap",
}




docker compose exec -T web python - <<'PY'
from app.db.repository import add_role
add_role("anhquantrinh", "recert_admin", actor="bootstrap")
PY

