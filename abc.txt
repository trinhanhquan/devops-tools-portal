import jenkins.model.*
import hudson.model.TopLevelItem

pipeline {
  agent any

  parameters {
    string(name: 'ORIGINAL_FULLNAME', defaultValue: 'IDB_entitlement-service/entitlement-service_aldon', description: 'Full name of original job')
    string(name: 'DRAFT_FULLNAME', defaultValue: 'DRAFTS/IDB_entitlement-service/entitlement-service_aldon_draft', description: 'Full name of draft job')
    booleanParam(name: 'DRY_RUN', defaultValue: true, description: 'If true, do not apply changes')
  }

  stages {
    stage('Backup original + export draft XML') {
      steps {
        script {
          // Lấy XML trong 1 scope ngắn, không giữ job object lâu
          def j = Jenkins.get()

          def originalItem = j.getItemByFullName(params.ORIGINAL_FULLNAME)
          def draftItem    = j.getItemByFullName(params.DRAFT_FULLNAME)

          if (!(originalItem instanceof TopLevelItem)) {
            error("Original job not found or not TopLevelItem: ${params.ORIGINAL_FULLNAME}")
          }
          if (!(draftItem instanceof TopLevelItem)) {
            error("Draft job not found or not TopLevelItem: ${params.DRAFT_FULLNAME}")
          }

          def original = (TopLevelItem) originalItem
          def draft    = (TopLevelItem) draftItem

          def oldXml = original.getConfigFile().asString()
          def newXml = draft.getConfigFile().asString()

          def ts = new Date().format("yyyyMMdd_HHmmss")
          def safe = { String s -> s.replaceAll(/[^A-Za-z0-9_.-]/, "_") }

          def backupFile = "backup_${safe(original.fullName)}_${ts}.config.xml"
          def draftFile  = "draft_${safe(draft.fullName)}_${ts}.config.xml"

          writeFile file: backupFile, text: oldXml, encoding: 'UTF-8'
          writeFile file: draftFile,  text: newXml, encoding: 'UTF-8'

          echo "✅ Backup saved: ${backupFile}"
          echo "✅ Draft XML saved: ${draftFile}"
          echo "Old XML size: ${oldXml.length()} | New XML size: ${newXml.length()}"

          archiveArtifacts artifacts: "${backupFile},${draftFile}", fingerprint: true

          // Đưa file draft xml sang stage sau bằng stash (an toàn hơn env/base64)
          stash name: 'draftXml', includes: draftFile
          // Lưu tên file draft vào env nhỏ gọn (chỉ tên file, không phải nội dung)
          env.DRAFT_XML_FILE = draftFile
        }
      }
    }

    stage('Override original from draft XML') {
      steps {
        script {
          if (params.DRY_RUN) {
            echo "DRY_RUN=true → không apply."
            return
          }

          // Lấy lại file draft xml từ stash
          deleteDir() // làm sạch workspace để chắc chắn dùng file từ stash
          unstash 'draftXml'

          def newXml = readFile(file: env.DRAFT_XML_FILE, encoding: 'UTF-8')

          // Apply ngay trong scope này, không giữ object qua nơi khác
          def j = Jenkins.get()
          def originalItem = j.getItemByFullName(params.ORIGINAL_FULLNAME)
          if (!(originalItem instanceof TopLevelItem)) {
            error("Original job not found or not TopLevelItem: ${params.ORIGINAL_FULLNAME}")
          }
          def original = (TopLevelItem) originalItem

          original.updateByXml(new javax.xml.transform.stream.StreamSource(new StringReader(newXml)))
          original.save()

          echo "✅ Overrode original job config.xml from draft."
        }
      }
    }
  }
}
